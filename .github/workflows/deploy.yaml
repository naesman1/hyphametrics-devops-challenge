name: CI/CD Log Archiver

on:
  push:
    tags:
      - 'v*' # Triggers on version tags like v1.0.17

jobs:
  deploy:
    name: Infrastructure and Application Deploy
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # --- STEP 1: CODE QUALITY (CI) ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Lint with Flake8
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 ./app --count --select=E9,F63,F7,F82 --show-source --statistics

      # --- STEP 2: AUTHENTICATION (WIF) ---
      - id: 'auth'
        name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: '${{ secrets.GCP_SA_EMAIL }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      # --- STEP 3: INFRASTRUCTURE (TERRAFORM) ---
      # Run Terraform first to ensure the Artifact Registry repository exists
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}"
        working-directory: ./terraform

      # --- STEP 4: SECURITY SCAN (DEVSECOPS) ---
      - name: Build Local Image for Scanning
        run: docker build -t local-scan-image:latest ./app

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'local-scan-image:latest'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          scanners: 'vuln'
          trivyignores: .trivyignore

      # --- STEP 5: DEPLOYMENT (DOCKER PUSH) ---
      - name: 'Docker Auth'
        run: |
          # Bridges gcloud authentication with the local docker daemon
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build and Push to Artifact Registry
        run: |
          # Repository is guaranteed to exist due to Step 3
          IMAGE_NAME="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/log-archiver-repo/app:${{ github.ref_name }}"
          docker build -t $IMAGE_NAME ./app
          docker push $IMAGE_NAME
      # --- STEP 6: DEPLOY TO CLOUD RUN ---
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: log-archiver-app
          region: us-central1
          image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/log-archiver-repo/app:${{ github.ref_name }}
          # Injecting the environment variables required by the Python script
          env_vars: |
            PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
            SUBSCRIPTION_NAME=log-archiver-sub
            BUCKET_NAME=${{ secrets.GCP_PROJECT_ID }}-log-archive-storage